<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>RAGAgent Chatbot</title>
<link rel="icon" href="data:," />
<style>
:root {
    --primary: #3578e5;
    --primary-dark: #21529e;
    --accent: #65d6ce;
    --grey-bg: #f4f7fa;
    --bot-bg: #e9f5ea;
    --user-bg: #d0e8ff;
    --border-radius: 14px;
}
html,body {
    height: 100%;
    margin: 0;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, var(--primary), var(--accent));
}
body {
    display: flex;
    align-items: center;
    justify-content: center;
}
.chat-container {
    background: #fff;
    max-width: 410px;
    width: 98%;
    min-width: 340px;
    max-height: 96vh;
    border-radius: var(--border-radius);
    box-shadow: 0 10px 32px rgba(40,60,90,0.09), 0 2.5px 10px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}
.chat-header {
    background: linear-gradient(90deg, var(--primary), var(--primary-dark));
    color: white;
    padding: 20px 24px;
    font-size: 1.32rem;
    font-weight: 700;
    display: flex;
    align-items: center;
    gap: 12px;
}
.chat-header span:first-child { font-size: 1.7rem; }
.session-picker {
    padding: 9px 20px;
    font-size: 1rem;
    border-bottom: 1px solid #e6e8ef;
    background: var(--grey-bg);
    display: flex;
    align-items: center;
    gap: 10px;
}
.session-picker label {
    font-size: 1rem;
    font-weight: 500;
    color: #37415c;
    display: flex;
    align-items: center;
    gap: 10px;
    flex: 1; 

}
.session-picker select {
    margin-left: 3px;
    font-size: 1rem;
    padding: 3.5px 12px;
    border-radius: 6px;
    border: 1px solid #b8c3ca;
}
#new-chat-btn {
    margin-left: 10px;
    background: var(--primary);
    color: #fff;
    border: none;
    border-radius: 6px;
    padding: 5px 12px;
    cursor: pointer;
    font-size: 0.9rem;
}
.chat-messages {
    padding: 18px 16px 14px 16px;
    overflow-y: auto;
    flex: 1;
    background: var(--grey-bg);
    display: flex;
    flex-direction: column;
    gap: 13px;
}
.message {
    max-width: 78%;
    padding: 13px 17px;
    border-radius: 24px;
    font-size: 1.01rem;
    line-height: 1.35;
    opacity: 0;
    animation: fadeInUp .34s forwards;
}
.user {
    align-self: flex-end;
    background: var(--user-bg);
    color: #18416c;
}
.bot {
    align-self: flex-start;
    background: var(--bot-bg);
    color: #297150;
}
.typing-indicator {
    font-size: .98rem;
    color: #297150;
    font-style: italic;
    opacity: 0.75;
}
@keyframes fadeInUp {
    from { opacity: 0; transform: translateY(13px);}
    to   { opacity:1;  transform: translateY(0);}
}
.chat-input {
    display: flex;
    border-top: 1px solid #e7edf2;
    background: #fff;
    padding: 13px;
    gap: 9px;
}
.chat-input input {
    flex: 1;
    border-radius: 9px;
    border: 1px solid #b8c3ca;
    padding: 11px 14px;
    font-size: 1rem;
    background: #f7fafc;
    color: #222c36;
}
.chat-input input:focus {
    border: 1.5px solid var(--primary);
    background: #fff;
}
.chat-input button {
    border: none;
    background: linear-gradient(90deg, var(--primary), var(--primary-dark));
    color: white;
    border-radius: 8px;
    font-size: 1rem;
    padding: 0 21px;
    cursor: pointer;
}
</style>
</head>
<body>
<main>
<div class="chat-container">
    <header class="chat-header">
        <span>🤖</span><span>RAGAgent Chatbot</span>
    </header>
    <nav class="session-picker">
        <label for="session-picker">
            <span>Session:</span>
            <select id="session-picker">
                <option value="">🆕 New</option>
            </select>
        </label>
        <button id="new-chat-btn">New Chat</button>
    </nav>
    <section class="chat-messages" id="messages">
        <div class="message bot" style="opacity:1;">👋 Hello! Ask me anything about the Leadership Team.</div>
    </section>
    <form class="chat-input" id="chat-form">
        <input id="question" type="text" placeholder="Type your question..." required>
        <button type="submit" id="send-btn">Ask</button>
    </form>
</div>
</main>

<script>
const form = document.getElementById("chat-form");
const input = document.getElementById("question");
const messages = document.getElementById("messages");
const sendBtn = document.getElementById("send-btn");
const sessionPicker = document.getElementById("session-picker");
const newChatBtn = document.getElementById("new-chat-btn");

function appendMessage(text, sender) {
    const typingEl = messages.querySelector(".typing-indicator");
    if (typingEl) typingEl.remove();
    const msg = document.createElement("div");
    msg.className = `message ${sender}`;
    msg.textContent = text;
    messages.appendChild(msg);
    messages.scrollTo({ top: messages.scrollHeight, behavior: "smooth" });
}

function appendTypingIndicator() {
    const typing = document.createElement("div");
    typing.className = "message bot typing-indicator";
    typing.textContent = "RAGAgent is typing…";
    messages.appendChild(typing);
    messages.scrollTo({ top: messages.scrollHeight, behavior: "smooth" });
}

function toggleInput(disabled) {
    input.disabled = disabled;
    sendBtn.disabled = disabled;
}

async function askQuestion(question) {
    if (!question.trim()) return;
    appendMessage(question, "user");
    toggleInput(true);
    appendTypingIndicator();

    let session_id = localStorage.getItem("session_id");
    const payload = { query: question };
    if (session_id) payload.session_id = session_id;

    try {
        const res = await fetch("http://127.0.0.1:8000/api/ask", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });
        const data = await res.json();
        if (data.session_id) {
            localStorage.setItem("session_id", data.session_id);
            await loadSessions();
        }
        appendMessage(data.answer || "🤷 Sorry, no answer found.", "bot");
    } catch {
        appendMessage("⚠️ Sorry, something went wrong.", "bot");
    } finally {
        toggleInput(false);
        input.focus();
    }
}

form.onsubmit = (e) => {
    e.preventDefault();
    const question = input.value;
    if (question.trim()) {
        input.value = "";
        askQuestion(question);
    }
};

sessionPicker.onchange = () => {
    const sid = sessionPicker.value;
    if (sid) {
        localStorage.setItem("session_id", sid);
        loadHistory(sid);
    } else {
        localStorage.removeItem("session_id");
        loadHistory(null);
    }
};

newChatBtn.onclick = () => {
    localStorage.removeItem("session_id");
    sessionPicker.value = "";
    loadHistory(null);
};

async function loadSessions() {
    try {
        const res = await fetch("http://127.0.0.1:8000/api/sessions");
        const sessions = await res.json();
        sessionPicker.innerHTML = `<option value="">🆕 New</option>`;
        sessions.forEach(s => {
            const opt = document.createElement("option");
            opt.value = s.session_id;
            opt.textContent = `${s.title} (${new Date(s.started_at).toLocaleTimeString()})`;
            if (s.session_id === localStorage.getItem("session_id")) opt.selected = true;
            sessionPicker.appendChild(opt);
        });
    } catch {}
}

async function loadHistory(session_id) {
    messages.innerHTML = ``;
    if (!session_id) {
        appendMessage("👋 Hello! Ask me anything about the Leadership Team.", "bot");
        return;
    }
    try {
        const res = await fetch(`http://127.0.0.1:8000/api/history/${session_id}`);
        const history = await res.json();
        if (history.length === 0) {
            appendMessage("👋 This session is empty. Ask me anything!", "bot");
        } else {
            history.forEach(item => {
                appendMessage(item.user_message, "user");
                appendMessage(item.bot_response, "bot");
            });
        }
    } catch {
        appendMessage("⚠️ Failed to load history.", "bot");
    }
}

window.onload = async () => {
    input.focus();
    await loadSessions();
    await loadHistory(localStorage.getItem("session_id"));
};
</script>
</body>
</html>
